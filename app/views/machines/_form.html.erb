<div class="page-header machine-form-header">
  <% if @machine.persisted? %>
    <h1>Stock <%= @machine.stock_number %></h1>
  <% else %>
    <h1>Add a Machine</h1>
  <% end %>
</div>

<%= form_for @machine, remote: true do |f| %>
  <% if @machine.errors.any? %>
    <%= render "shared/errors", resource: @machine %>
  <% end %>

  <div class="row">
    <div class="col-md-6 machine-form-column">
      <div class="form-group">
        <%= f.label :stock, class: "control-label" %>
        <%= f.text_field :stock_number, class: "form-control",
                                        autofocus: "autofocus",
                                        value: @machine.stock_number %>
      </div>

      <div class="form-group">
        <%= f.label :year, class: "control-label" %>
        <%= f.select :year, [], {}, { class: "form-control" } do %>
          <% if @machine.year != nil %>
            <%= content_tag :option, @machine.year, selected: "selected" %>
            <%= content_tag :option, "--", disabled: "disabled"  %>
          <% end %>
          <%= content_tag :option, "Choose year:", disabled: "disabled" %>
          <% 41.times do |n| %>
            <%= content_tag(:option, (Time.now.year + 1) - n) %>
          <% end %>
          <%= content_tag :option, "Other..." %>
        <% end %>
      </div>

      <div class="form-group">
        <%= f.label :make, class: "control-label" %>
        <%= f.text_field :make, class: "form-control", value: @machine.make %>
      </div>

      <div class="form-group">
        <%= f.label :model, class: "control-label" %>
        <%= f.text_field :machine_model, class: "form-control", value: @machine.machine_model %>
      </div>

      <div class="form-group">
        <%= f.label :type, class: "control-label" %>
        <%= f.text_field :machine_type, class: "form-control", value: @machine.machine_type %>
      </div>
    </div>

    <div class="col-md-6 machine-form-column">
      <div class="form-group">
        <%= f.label :serial, class: "control-label" %>
        <%= f.text_field :serial_number, class: "form-control", value: @machine.serial_number %>
      </div>

      <div class="form-group">
        <%= f.label :hours, class: "control-label" %>
        <%= f.text_field :hours, class: "form-control", value: @machine.hours %>
      </div>

      <div class="form-group">
        <%= f.label :price, class: "control-label" %>
        <div class="input-group">
          <span class="input-group-addon">$</span>
          <%= f.text_field :price, class: "form-control",
                                   value: @machine.price,
                                   placeholder: "No decimals or dollar signs please!" %>
        </div>
      </div>

      <div class="form-group">
        <%= f.label :dealership_id, "Location", class: "control-label" %>
        <%= f.select :dealership_id, [], {}, { class: "form-control" } do %>
          <% if @machine.year != nil %>
            <%= content_tag :option,
                            @machine.location.city,
                            selected: "selected",
                            value: @machine.location.id %>
            <%= content_tag :option, "--", disabled: "disabled" %>
          <% end %>
          <%= content_tag :option, "Choose location:", disabled: "disabled" %>
          <% current_user.dealerships.each do |dealership| %>
            <%= content_tag :option, dealership.city, value: dealership.id %>
          <% end %>
        <% end %>
      </div>

      <div class="form-group">
        <%= f.label :description, class: "control-label" %>
        <%= f.text_area :description, class: "form-control", rows: "4", value: @machine.description %>
      </div>
    </div>
  </div>

  <hr />

  <div class="row machine-form-buttons">
    <div class="col-md-12 text-center">
      <p>
        <%= button_tag "Save", type: "button",
                               "data-toggle" => "modal",
                               "data-target" => "#listing-checklist-modal",
                               class: "btn btn-success update-listings" %>
        or
        <%= link_to "Cancel", machines_path, class: "cancel-machine", remote: true %>
      </p>
      <% if @machine.persisted? %>
        <%= link_to "Delete Machine", machine_path(@machine.id),
                                      method: "delete",
                                      confirm: "Are you sure you want to delete this machine?",
                                      class: "btn btn-danger delete-machine" %>
      <% end %>
    </div>
  </div>
  <div class="modal fade" id="listing-checklist-modal" tabindex="-1"
                                                       role="dialog"
                                                       aria-labelledby="listingChecklistModalLabel"
                                                       aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
          <h4 class="modal-title">Let's go update those listings!</h4>
        </div>
        <div class="modal-body listing-checklist-body text-center">
          <% @machine.listings.each do |listing| %>
            <% if listing.equip_alley %>
              <div class="site-checkbox current-listing">
                <%= image_tag image_path("equipment-alley.png") %>
                <p>
                  <%= link_to "Up to date", "https://www.equipmentalley.com/main/user/login",
                                                target: "_blank",
                                                class: "btn btn-sm btn-success",
                                                disabled: true %>
                </p>
              </div>
            <% end %>
            <% if listing.equip_locator %>
              <div class="site-checkbox outdated-listing">
                <%= image_tag image_path("equipment-locator.png") %>
                <p>
                  <%= link_to "Update listing", "http://www.equipmentlocator.com/maint/login.aspx",
                                                target: "_blank",
                                                class: "btn btn-sm btn-danger" %>
                </p>
              </div>
            <% end %>
            <% if listing.mach_trader %>
              <div class="site-checkbox outdated-listing">
                <%= image_tag image_path("machinery-trader.png") %>
                <p>
                  <%= link_to "Update listing", "https://dscrm.sandhills.com/main.aspx",
                                                target: "_blank",
                                                class: "btn btn-sm btn-danger" %>
                </p>
              </div>
            <% end %>
          <% end %>
        </div>
        <div class="modal-footer">
          <%= f.submit "I'll do this later", class: "btn btn-default save-machine listings-done-later" %>
          <%= f.submit "All listings up to date", class: "btn btn-primary save-machine listings-done-now" %>
        </div>
      </div>
    </div>
  </div>
<% end %>
